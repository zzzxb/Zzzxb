<link rel="shortcut icon" href="https://gitlab.com/zzzxb/Snake/-/raw/master/vim-snake/assets/favicon.ico?ref_type=heads" type="image/x-icon" />
<link href="/assets/css/main.css" rel="stylesheet"/>

<style>
    body {
        margin: 0;
        padding: 0;
    }
    #container{
        text-align: center;
        margin: 0 auto;
        padding: 0;
        width: 100%;
        height: 100%;
        opacity: 0.96;
    }
    @media screen and (min-width: 1200px) {
      #container{
        width: 50%;
        height: inherit;
      }
      .screen {
        width: 100%;
      }
      .ctrl {
        display: none;
      }
    }
</style>

<div id="container" class="no_select">
  <div class="box" id="box">
    <div class="title">
        <span id ="score">&numsp;</span>
    </div>

    <div class="screen" id="screen"></div>
    <div class="ctrl" style="position: relative">
    <div class="ctrl" style="position: absolute; left: 128px;" onclick="touch('u')">
        <svg t="1735145609552" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13464" width="128" height="128"><path d="M512 32C248 32 32 248 32 512s216 480 480 480 480-216 480-480S776 32 512 32z" fill="#FFFFFF" p-id="13465"></path><path d="M512 0C228.8 0 0 228.8 0 512s228.8 512 512 512 512-228.8 512-512S795.2 0 512 0z m0 992C248 992 32 776 32 512S248 32 512 32s480 216 480 480-216 480-480 480z" fill="" p-id="13466"></path><path d="M512 512m-392 0a392 392 0 1 0 784 0 392 392 0 1 0-784 0Z" fill="#9DE8F7" p-id="13467"></path><path d="M466.745166 507.4745166l0 199.12126958 81.4587012 0 0-199.12126958 99.56063479 0-142.55272709-201.38401128-142.55272709 201.38401128z" fill="#FFFFFF" p-id="13468"></path><path d="M581.01362184 538.02152955l128.97627689 0-203.64675298-289.63093758-203.64675298 289.63093758 133.50176029 0 0 199.12126958 144.81546878 0 0-199.12126958z m66.75088015-30.54701295l-99.56063479 0 0 199.12126958-81.4587012 0 0-199.12126958-104.08611819 0 142.55272709-201.38401128 142.55272709 201.38401128z" fill="" p-id="13469"></path></svg>
    </div>
    <div class="ctrl" style="position: absolute; top:256px; left: 128px;" onclick="touch('d')">
        <svg t="1735145662679" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13868" width="128" height="128"><path d="M512 32C248 32 32 248 32 512s216 480 480 480 480-216 480-480S776 32 512 32z" fill="#FFFFFF" p-id="13869"></path><path d="M512 0C228.8 0 0 228.8 0 512s228.8 512 512 512 512-228.8 512-512S795.2 0 512 0z m0 992C248 992 32 776 32 512S248 32 512 32s480 216 480 480-216 480-480 480z" fill="" p-id="13870"></path><path d="M512 512m-392 0a392 392 0 1 0 784 0 392 392 0 1 0-784 0Z" fill="#9DE8F7" p-id="13871"></path><path d="M557.254834 516.5254834l0-199.12126958-81.4587012 0 0 199.12126958-99.56063479 0 142.55272709 201.38401128 142.55272709-201.38401128z" fill="#FFFFFF" p-id="13872"></path><path d="M442.98637816 485.97847045l-128.97627689 0 203.64675298 289.63093758 203.64675298-289.63093758-133.50176029 0 0-199.12126958-144.81546878 0 0 199.12126958z m-66.75088015 30.54701295l99.56063479 0 0-199.12126958 81.4587012 0 0 199.12126958 104.08611819 0-142.55272709 201.38401128-142.55272709-201.38401128z" fill="" p-id="13873"></path></svg>
    </div>
    <div class="ctrl" style="position: absolute;top:128px; left: 0;" onclick="touch('l')">
        <svg t="1735145829369" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14562" width="128" height="128"><path d="M512 32C248 32 32 248 32 512s216 480 480 480 480-216 480-480S776 32 512 32z" fill="#FFFFFF" p-id="14563"></path><path d="M512 0C228.8 0 0 228.8 0 512s228.8 512 512 512 512-228.8 512-512S795.2 0 512 0z m0 992C248 992 32 776 32 512S248 32 512 32s480 216 480 480-216 480-480 480z" fill="" p-id="14564"></path><path d="M512 512m-392 0a392 392 0 1 0 784 0 392 392 0 1 0-784 0Z" fill="#9DE8F7" p-id="14565"></path><path d="M507.4745166 557.254834l199.12126958 0 0-81.4587012-199.12126958 0 0-99.56063479-201.38401128 142.55272709 201.38401128 142.55272709z" fill="#FFFFFF" p-id="14566"></path><path d="M538.02152955 442.98637816l0-128.97627689-289.63093758 203.64675298 289.63093758 203.64675298 0-133.50176029 199.12126958 0 0-144.81546878-199.12126958 0z m-30.54701295-66.75088015l0 99.56063479 199.12126958 0 0 81.4587012-199.12126958 0 0 104.08611819-201.38401128-142.55272709 201.38401128-142.55272709z" fill="" p-id="14567"></path></svg>
    </div>
    <div class="ctrl" style="position: absolute;top:128px; left: 256px;" onclick="touch('r')">
        <svg t="1735145695424" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14360" width="128" height="128"><path d="M512 32C248 32 32 248 32 512s216 480 480 480 480-216 480-480S776 32 512 32z" fill="#FFFFFF" p-id="14361"></path><path d="M512 0C228.8 0 0 228.8 0 512s228.8 512 512 512 512-228.8 512-512S795.2 0 512 0z m0 992C248 992 32 776 32 512S248 32 512 32s480 216 480 480-216 480-480 480z" fill="" p-id="14362"></path><path d="M512 512m-392 0a392 392 0 1 0 784 0 392 392 0 1 0-784 0Z" fill="#9DE8F7" p-id="14363"></path><path d="M516.5254834 466.745166l-199.12126958 0 0 81.4587012 199.12126958 0 0 99.56063479 201.38401128-142.55272709-201.38401128-142.55272709z" fill="#FFFFFF" p-id="14364"></path><path d="M485.97847045 581.01362184l0 128.97627689 289.63093758-203.64675298-289.63093758-203.64675298 0 133.50176029-199.12126958 0 0 144.81546878 199.12126958 0z m30.54701295 66.75088015l0-99.56063479-199.12126958 0 0-81.4587012 199.12126958 0 0-104.08611819 201.38401128 142.55272709-201.38401128 142.55272709z" fill="" p-id="14365"></path></svg>
    </div>
    <div class="ctrl" style="position: absolute; right: 0px;" onclick="touch('e')">
        <svg t="1735147383935" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="25442" width="128" height="128"><path d="M512 85.333a425.813 425.813 0 0 1 330.368 156.63L572.331 512l270.037 270.037A425.813 425.813 0 0 1 512 938.667C276.352 938.667 85.333 747.648 85.333 512S276.352 85.333 512 85.333z m0 128a64 64 0 1 0 0 128 64 64 0 0 0 0-128z" fill="#e6a612" p-id="25443"></path></svg>
    </div>
    <div class="ctrl" style="position: absolute;top:256px; right: 0px;" onclick="touch('i')">
        <svg t="1735147413075" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1485" width="128" height="128"><path d="M1014.272 511.488c0 71.68-58.368 130.048-130.56 130.048s-130.56-58.368-130.56-130.048 58.368-130.048 130.56-130.048 130.56 57.856 130.56 130.048z m-192 268.8c1.024 8.704-2.048 17.408-7.68 24.064-120.832 144.384-317.952 199.68-496.128 139.264C140.288 882.688 17.92 718.848 10.24 530.944 3.072 342.016 111.616 168.96 284.672 94.208c172.544-74.752 373.76-35.84 505.856 98.304 6.144 6.144 9.728 14.336 9.728 23.04 0 8.704-3.584 16.896-9.728 23.04-71.168 66.048-218.112 211.968-276.992 270.336 60.928 51.712 209.408 178.176 296.96 248.32 6.656 6.144 11.264 14.336 11.776 23.04zM394.24 330.752c0-28.672-23.552-52.224-52.224-52.224S289.792 302.08 289.792 330.752s23.552 52.224 52.224 52.224S394.24 359.424 394.24 330.752z" p-id="1486" fill="#e6a612"></path></svg>
    </div>
    </div>
    </div>
</div>
</div>
<script>
  window.onload = run;
  document.onkeydown = keyDown;

  const world = initWorld();
  const init_snakeLength = 3;

let goto_xy = objArray(world.width, world.height);
let snake_x = new Array(), snake_y = new Array(),
    food_x = new Array(), food_y = new Array();
let keyCode, mode, foodNum = 2, speed, score, game;
let bgc="#586e3d";
let gameOverAudio = new Audio("https://gitlab.com/zzzxb/Snake/-/raw/master/vim-snake/assets/over.mp3?ref_type=heads");
let bgm = new Audio("https://gitlab.com/zzzxb/Snake/-/raw/master/vim-snake/assets/bg.mp3?ref_type=heads");
let gold = new Audio("https://gitlab.com/zzzxb/Snake/-/raw/master/vim-snake/assets/sfx.wav?ref_type=heads");

function initWorld() {
    h = window.innerHeight;
    w = window.innerWidth;
    width = 60;
    height = 60;
    size = 10;
    if(w < 800){
        size = (w - 10) / 60;
    }
    return{
        width: width, 
        height: height, 
        size: size
    }
}

function run() {
    createWorld();
    // alert("Guide :" +
          // "\nNormal : ESC"+
          // "\nInsert  : I"+
          // "\n-wards : H, J, K, L");
    init();
    ico();
}

function init() {
    clearScreen();
    game = false;
    score = 0; 
    foodNum = 2;
    speed = 100;
    keyCode = 0;
    mode = false;

    snake_x = [];
    snake_y = [];
    food_x = [];
    food_y = [];
    initSnake();
}

function ico() {
  for(i=15; i<=45; i++)
    goto_xy[i][15].style.backgroundColor = bgc;
  for(i=15; i<=35; i++)
    goto_xy[i][1].style.backgroundColor = bgc;
  for(i=0; i<=20; i++)
    goto_xy[30][i].style.backgroundColor = bgc;
  for(i=16; i<30; i++)
    goto_xy[15][i].style.backgroundColor = "#fdb933";
  for(i=16; i<55; i++)
    goto_xy[40][i].style.backgroundColor = "#fdb933";
  for(i=17; i< 45; i++)
    goto_xy[i][30].style.backgroundColor = bgc;
  for(i=25; i<50; i++)
    goto_xy[i][40].style.backgroundColor = bgc;
  for(i=50; i<=58; i++)
    colorXY(i, 15, "#fdb933")
  for(i=12; i < 30; i++)
    colorXY(56, i, "#fdb933")
}

function colorXY(x, y, color) {
  goto_xy[y][x].style.backgroundColor = color;
}

function render() {
    if(game) {
        control();
        getFood();
        createFood();
        drawSnake();
    }
}

function getFood() {
    for (let i = 0; i < food_x.length; i++) {
        if (game && mode && snake_x[0] == food_x[i] && snake_y[0] == food_y[i]) {
            gold.currentTime = 0;
            gold.play();
            food_x.splice(i,1);
            food_y.splice(i,1);
            foodNum ++;
            score ++;
        }
    }
    document.getElementById("score").innerHTML = "<strong>Score : </strong>" + score;
}

let start;
function touch(bt) {
    if(bt === 'e') {
        mode = false
    } else if(bt === 'i') {
        mode = true;
        if (!game) {
            init();
            bgm.loop = true;
            bgm.play();
            keyCode = 74;
            game = true;
            window.clearInterval(start);
            clearScreen();
            start = window.setInterval("render()", speed);
        }
    }
    if(game && !mode) {
        switch(bt) {
            case 'l': if (keyCode != 76) keyCode = 72; break; // h -> left
            case 'd': if (keyCode != 75) keyCode = 74; break; // j -> down
            case 'u': if (keyCode != 74) keyCode = 75; break; // k -> up
            case 'r': if (keyCode != 72) keyCode = 76; break; // l - right
        }
    }
}

function keyDown(e) {
    if (game && (e.which == 27 || (e.ctrlKey && e.which == 219))) { // esc 或 control + [
        mode = false;
    }else if (e.which == 73) { // i -> insert
        mode = true;
        if (!game) {
            init();
            bgm.loop = true;
            bgm.play();
            keyCode = 74;
            game = true;
            window.clearInterval(start);
            clearScreen();
            start = window.setInterval("render()", speed);
        }
    }

    if (game && !mode) {
        switch(e.which) {
            case 72: if (keyCode != 76) keyCode = 72; break; // h -> left
            case 74: if (keyCode != 75) keyCode = 74; break; // j -> down
            case 75: if (keyCode != 74) keyCode = 75; break; // k -> up
            case 76: if (keyCode != 72) keyCode = 76; break; // l - right
        }
    }
}

function control() {
    let x = 0, y = 0;
    switch (keyCode) {
        case 72: x = 0; y = -1; break;
        case 76: x = 0; y = 1; break;
        case 75: x = -1; y = 0; break;
        case 74: x = 1; y = 0; break;
    }
    snake_x.unshift(snake_x[0] + x);
    snake_y.unshift(snake_y[0] + y);
    gameOverOrwine();
}

function  clearScreen() {
    for (let i = 0; i < world.width; i++) {
        for (let j = 0; j < world.height; j++) {
            goto_xy[i][j].style.backgroundColor = "rgba(0,0,0,0)";
        }
    }
}

function createFood() {
    let superposition = true;
    for (let i = 0; i < foodNum; i++) {
        if (foodNum > 0) {
            let x = Math.round(Math.random() * world.width - 1);
            let y = Math.round(Math.random() * world.height - 1);
            food_x.unshift(x);
            food_y.unshift(y);
            foodNum--;
        }
    }
    for (let i = 0; i < food_x.length && game; i++) {
        goto_xy[food_x[i]][food_y[i]].style.backgroundColor = "#fdb933";
    }
}

function drawSnake() {
    for (let i = 0; i < snake_x.length && game; i++) {
            goto_xy[snake_x[i]][snake_y[i]].style.backgroundColor = "#586e3d";
    }
    if ((score + init_snakeLength) < snake_x.length)
        goto_xy[snake_x.pop()][snake_y.pop()].style.backgroundColor = "rgba(0,0,0,0)";
}

function initSnake() {
    if (init_snakeLength > 0 &&  init_snakeLength < world.width/2){
        for (let i = 0; i < init_snakeLength ; i++) {
            snake_x[i] = (world.width / 2) - i;
            snake_y[i] = world.height / 2;
        }
    }
}

function createWorld() {
    const body = document.getElementById("container");
    const box = document.getElementById("box");
    const screen = document.getElementById("screen");
    screen.appendChild(document.createElement("table"));
    const table = document.getElementsByTagName("table")[0];
    // 加入css样式
    style(body, box, screen, table);
    // 添加表格
    for (let i = 0; i < world.height; i++) {
        let tr = document.createElement("tr");
        for (let j = 0; j < world.width; j++) {
            let td = document.createElement("td");
            td.style.cursor = 'none';
            td.style.height = world.size + "px";
            td.style.width = world.size + "px";
            goto_xy[i][j] = tr.appendChild(td);
        }
        table.appendChild(tr);
    }
}

function style(body, box, screen, table) {
    // document.getElementsByTagName("h1")[0].innerHTML = " Vim-Snake "
    body.style.backgroundColor = "#586e3d";
    box.style.textAlign = "center";
    box.style.margin = "0 auto"
    box.style.width = (((world.size) * world.width)/16)+ "em";
    screen.style.border = "1px solid black";
    table.style.backgroundColor = "#92ae57";
    table.style.borderpadding = "0";
    table.style.borderSpacing = "0";
    // document.getElementById("highest").innerHTML = "Highest Score : "
}

function objArray(line, row) {
    let to_xy = new Array(line);
    for (let i = 0; i < row; i++) {
        to_xy[i] = new Array(row);
    }
    return to_xy;
}

function gameOverOrwine() {
    for (let i = 1; i < snake_x.length; i++) {
        if ((snake_x[0] == snake_x[i]) && (snake_y[0] == snake_y[i])) {
            alertOver();
        }
    }
    if (snake_x[0] < 0 || snake_y[0] < 0 ||
        snake_x[0] > world.width-1 || snake_y[0] > world.height - 1) {
            alertOver();
    }else if ((score + init_snakeLength) == (world.width * world.height) ) {
        alert("Winner !" + "\nScore : " + score)
            clearScreen();
            init();
    }

}

function alertOver(){
            game = false;
            bgm.pause();
            gameOverAudio.play();
            bgm.currentTime = 0;
            alert("Game Over !" + "\nScore : " + score)
            clearScreen();
            gameOverAudio.pause();
            gameOverAudio.currentTime = 0;
            ico();
            // init();
}
</script>
